<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Merge Tactics 排位工具</title>
  <style>
    body {
      margin: 0;
      background: #101820;
      font-family: sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    h1 {
      margin-bottom: 4px;
    }
    h2 {
      color: #4fff4f;
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 14px;
    }
    #board {
      position: relative;
      width: 400px; /* 擴大寬度以容納偏移 */
      height: 460px;
    }
    .hex {
      width: 60px;
      height: 52px;
      background: #3a3f4b;
      clip-path: polygon(50% 0%, 93% 25%, 93% 75%, 50% 100%, 7% 75%, 7% 25%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      cursor: pointer;
    }
    .hex img {
      max-width: 100%;
      max-height: 100%;
      pointer-events: none;
    }
    #card-pool {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .card {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      overflow: hidden;
      cursor: grab;
    }
    .card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #traits {
      margin-top: 15px;
      color: #ccc;
      font-size: 14px;
      line-height: 1.4;
    }
    #controls {
      margin-top: 10px;
    }
    button {
      background: #4a90e2;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 4px;
    }
  </style>
</head>
<body>
  <h1>合成奇兵 排位工具</h1>
  <h2>CreatorCode：Xiake</h2>
  <div id="board"></div>
  <div id="controls">
    <button onclick="clearBoard()">一鍵清除</button>
  </div>
  <div id="traits"></div>
  <div id="card-pool"></div>

  <script>
    const board = document.getElementById("board");
    const cardPool = document.getElementById("card-pool");
    const traitsDisplay = document.getElementById("traits");

    const rows = 8;
    const cols = 5;
    const hexWidth = 60;
    const hexHeight = 52;

    const traitMap = {
      archer: ["Clan", "Ranger"],
      archer_queen: ["Clan", "Avenger"],
      bandit: ["Ace", "Avenger"],
      barbarian: ["Clan", "Brawler"],
      bomber: ["Undead", "Thrower"],
      goblin: ["Goblin", "Assassin"],
      dart_goblin: ["Goblin", "Ranger"],
      executioner: ["Ace", "Thrower"],
      giant_skeleton: ["Undead", "Brawler"],
      goblin_machine: ["Goblin", "Juggernaut"],
      golden_knight: ["Noble", "Assassin"],
      knight: ["Noble", "Juggernaut"],
      mega_knight: ["Ace", "Brawler"],
      pekka: ["Ace", "Juggernaut"],
      prince: ["Noble", "Brawler"],
      princess: ["Noble", "Ranger"],
      royal_ghost: ["Undead", "Assassin"],
      skeleton_king: ["Undead", "Juggernaut"],
      spear_goblin: ["Goblin", "Thrower"],
      valkyrie: ["Clan", "Avenger"],
    };

    const traitCount = {};

    function updateTraitsDisplay() {
      traitsDisplay.innerHTML = "";
      const entries = Object.entries(traitCount).filter(([, count]) => count > 0);
      if (entries.length === 0) return;
      traitsDisplay.innerHTML = "<strong>羈絆：</strong><br>" + entries.map(([trait, count]) => `${trait} x ${count}`).join("<br>");
    }

    function addTraits(name) {
      const traits = traitMap[name] || [];
      traits.forEach(t => traitCount[t] = (traitCount[t] || 0) + 1);
      updateTraitsDisplay();
    }

    function removeTraits(name) {
      const traits = traitMap[name] || [];
      traits.forEach(t => traitCount[t] = Math.max(0, (traitCount[t] || 0) - 1));
      updateTraitsDisplay();
    }

    for (let y = 0; y < rows; y++) {
      for (let x = 0; x < cols; x++) {
        const hex = document.createElement("div");
        hex.className = "hex";

        // ✅ 奇數行右移整格
        hex.style.left = `${x * hexWidth + (y % 2 === 0 ? hexWidth / 2 : 0)}px`;
        hex.style.top = `${y * (hexHeight * 0.82)}px`;
        hex.dataset.x = x;
        hex.dataset.y = y;

        hex.ondragover = e => e.preventDefault();
        hex.ondrop = e => {
          e.preventDefault();
          const name = e.dataTransfer.getData("card-name");
          const imgURL = e.dataTransfer.getData("text/plain");
          if (!hex.querySelector("img")) {
            hex.innerHTML = `<img src="${imgURL}" data-name="${name}" />`;
            addTraits(name);
          }
        };

        // 點擊可移除卡片與羈絆
        hex.onclick = () => {
          const img = hex.querySelector("img");
          if (img) {
            const name = img.getAttribute("data-name");
            hex.innerHTML = "";
            removeTraits(name);
          }
        };

        board.appendChild(hex);
      }
    }

    function clearBoard() {
      document.querySelectorAll(".hex").forEach(hex => hex.innerHTML = "");
      Object.keys(traitCount).forEach(key => traitCount[key] = 0);
      updateTraitsDisplay();
    }

    const cardNames = Object.keys(traitMap);
    cardNames.forEach(name => {
      const card = document.createElement("div");
      card.classList.add("card");
      card.draggable = true;
      card.ondragstart = e => {
        e.dataTransfer.setData("text/plain", `images/${name}.png`);
        e.dataTransfer.setData("card-name", name);
      };
      card.innerHTML = `<img src="images/${name}.png" />`;
      cardPool.appendChild(card);
    });
  </script>
</body>
</html>
